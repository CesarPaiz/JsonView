---
export const prerender = false;
import Layout from "../../Layout/index.astro";

const dataParam = Astro.request.url;
const search = Astro.url.searchParams.get("data") || "";
let parsedData = null;
let error = null;

try {
    parsedData = dataParam ? JSON.parse(decodeURIComponent(dataParam)) : null;
} catch {
    error = "JSON inválido o malformado.";
}

// 1. Datos del Recibo
// TODO: Pega aquí tu objeto JSON para llenar el recibo.
const reciboData: any = JSON.parse(search);

// 2. Extraer las secciones principales del JSON para fácil acceso
const {
    identificacion,
    emisor,
    receptor,
    cuerpoDocumento,
    resumen,
    selloRecepcion,
} = reciboData;

// 3. Función para formatear moneda
const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
    }).format(amount ?? 0); // Usa 0 si el valor es nulo
};
---

<Layout>
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6 font-sans">
        <header class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800 uppercase">
                {emisor?.nombre}
            </h1>
            <p class="text-sm text-gray-600">{emisor?.nombreComercial}</p>
            <p class="text-xs text-gray-500 mt-1">
                {emisor?.direccion?.complemento}
            </p>
            <p class="text-xs text-gray-500">
                NIT: {emisor?.nit} | NRC: {emisor?.nrc}
            </p>
            <p class="text-xs text-gray-500">
                Tel: {emisor?.telefono} | Email: {emisor?.correo}
            </p>
        </header>

        <hr class="border-dashed my-4" />

        <section class="mb-6">
            <h2 class="text-lg font-semibold text-center text-gray-700 mb-2">
                FACTURA ELECTRÓNICA
            </h2>
            <div class="flex justify-between text-sm text-gray-600">
                <span>Fecha:</span>
                <span>{identificacion?.fecEmi}</span>
            </div>
            <div class="flex justify-between text-sm text-gray-600">
                <span>Hora:</span>
                <span>{identificacion?.horEmi}</span>
            </div>
            <div class="flex justify-between text-sm font-medium text-gray-800">
                <span>Nº de Control:</span>
                <span>{identificacion?.numeroControl}</span>
            </div>
        </section>

        <section class="mb-6 p-4 bg-gray-50 rounded-md">
            <h3
                class="font-semibold text-gray-800 border-b border-dashed pb-2 mb-2"
            >
                Cliente
            </h3>
            <p class="font-medium text-gray-700">{receptor?.nombre}</p>
            <p class="text-sm text-gray-600">
                {receptor?.direccion?.complemento}
            </p>
        </section>

        <section class="mb-6">
            <div
                class="flex text-sm font-semibold text-gray-700 border-b-2 border-gray-300 pb-2"
            >
                <div class="w-1/6 text-left">Cant.</div>
                <div class="w-3/6 text-left">Descripción</div>
                <div class="w-1/6 text-right">P. Unit.</div>
                <div class="w-1/6 text-right">Total</div>
            </div>

            <div class="mt-2 space-y-2">
                {
                    cuerpoDocumento?.map((item: any) => (
                        <div class="flex text-sm text-gray-800">
                            <div class="w-1/6 text-left">{item.cantidad}</div>
                            <div class="w-3/6 text-left">
                                {item.descripcion}
                            </div>
                            <div class="w-1/6 text-right">
                                {formatCurrency(item.precioUni)}
                            </div>
                            <div class="w-1/6 text-right font-medium">
                                {formatCurrency(item.ventaGravada)}
                            </div>
                        </div>
                    ))
                }
            </div>
        </section>

        <hr class="border-dashed my-4" />

        <section class="mb-6">
            <div class="space-y-2">
                <div class="flex justify-between text-sm text-gray-600">
                    <span>Subtotal:</span>
                    <span>{formatCurrency(resumen?.subTotal)}</span>
                </div>
                <div class="flex justify-between text-sm text-gray-600">
                    <span>IVA (13%):</span>
                    <span>{formatCurrency(resumen?.totalIva)}</span>
                </div>
                <div
                    class="flex justify-between text-lg font-bold text-gray-800 mt-2 pt-2 border-t border-dashed"
                >
                    <span>TOTAL A PAGAR:</span>
                    <span>{formatCurrency(resumen?.totalPagar)}</span>
                </div>
            </div>
            <p class="text-center text-sm font-semibold text-gray-700 mt-4">
                {resumen?.totalLetras}
            </p>
        </section>

        <footer class="text-center text-xs text-gray-400 mt-6">
            <p class="font-mono break-all mb-2">
                <span class="font-semibold">Código Generación:</span>
                {identificacion?.codigoGeneracion}
            </p>
            <p class="font-mono break-all mb-4">
                <span class="font-semibold">Sello Recepción:</span>
                {selloRecepcion}
            </p>
            <p class="font-semibold text-gray-600">
                ¡Gracias por su compra! 🧾
            </p>
        </footer>
    </div>
</Layout>
